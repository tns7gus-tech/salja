const textByLang = {
  ko: {
    hero: "죽지 말고, 살자. 오늘 하루만 같이 버티자.",
    generate: "오늘의 SALJA 받기",
    reroll: "다시 받기",
    save: "문장 저장",
    share: "공유 문구 복사",
    quick: "Get SALJA",
    lang: "Language",
    ticker: "Ticker: SALJA",
    keys: [
      "웃긴 캡션 (밈 스타일)",
      "위로 문장",
      "짧은 시",
      "명언 의역",
      "오늘의 작은 행동"
    ],
    whyTitle: "WHY SALJA",
    why1: "비교 피로와 무기력의 루프에서 잠시 벗어날 수 있도록, 30초 안에 읽히는 위로를 제공합니다.",
    why2: "밈 감성으로 마음의 문턱을 낮추고, 짧은 시와 행동 한 가지로 오늘을 버틸 에너지를 돕습니다.",
    safeTitle: "SAFETY",
    safe1: "이 서비스는 의료·진단·치료를 대체하지 않습니다.",
    safe2: "즉시 위험하다고 느껴지면 지역 긴급 전화와 신뢰 가능한 위기지원 기관에 바로 연락하세요.",
    resourceTitle: "도움 리소스",
    resources: [
      {
        text: "국가별 위기상담 찾기",
        label: "Findahelpline",
        url: "https://findahelpline.com"
      },
      {
        text: "글로벌 정서지원 네트워크",
        label: "Befrienders Worldwide",
        url: "https://www.befrienders.org"
      },
      {
        text: "미국 거주 중 위기 상황이면",
        label: "988 Lifeline",
        url: "https://988lifeline.org"
      }
    ],
    footer: "© SALJA. Keep going, one day at a time.",
    copyOk: "복사되었습니다.",
    copyFail: "복사에 실패했습니다.",
    meme: [
      "인생 난이도: 하드모드인데 튜토리얼은 생략됨",
      "내 멘탈 배터리 2%인데도 오늘까지 왔다",
      "다들 잘 사는 것 같아도, 사실 다들 버티는 중",
      "오늘의 목표: 무너지지 말고 버티기 클리어"
    ],
    comfort: [
      "오늘의 너는 충분히 잘하고 있어. 완벽하지 않아도 괜찮아.",
      "남들 속도 말고 네 호흡으로 가도 된다.",
      "무너지지 않으려고 애쓴 하루, 그 자체로 의미가 있다.",
      "해야 할 일을 다 못해도, 살아낸 하루는 이미 큰일을 한 거야."
    ],
    poem: [
      "조용한 밤에도\n네 마음은 살아 있고\n내일은 다시 온다",
      "넘어져도 괜찮다\n오늘의 너는\n포기하지 않았다",
      "비교를 멈춘 자리에서\n작은 숨 하나가\n희망이 된다",
      "깊은 한숨 끝에\n아주 작은 용기가\n다시 켜진다"
    ],
    quote: [
      "폭풍은 영원하지 않다. 지금의 밤도 결국 지나간다.",
      "큰 변화는 대개 작은 반복에서 시작된다.",
      "천천히 가도 멈추지 않으면, 너는 앞으로 가고 있다.",
      "완벽보다 중요한 건, 포기하지 않는 방향이다."
    ],
    action: [
      "물 한 컵 마시고, 어깨를 10초 펴기",
      "휴대폰 내려놓고 창밖 30초 바라보기",
      "지금 감정을 한 문장으로 메모하기",
      "자리에서 천천히 5번 깊게 호흡하기"
    ]
  },
  en: {
    hero: "Stay alive. Hold on for today, just one day.",
    generate: "Get Today's SALJA",
    reroll: "Refresh",
    save: "Save Text",
    share: "Copy Share Text",
    quick: "Get SALJA",
    lang: "Language",
    ticker: "Ticker: SALJA",
    keys: [
      "Meme Caption",
      "Comfort Line",
      "Short Poem",
      "Reframed Quote",
      "One Small Action"
    ],
    whyTitle: "WHY SALJA",
    why1: "SALJA gives 30-second emotional support when comparison fatigue and numbness hit.",
    why2: "Humor lowers the barrier, then one small action helps you carry this day.",
    safeTitle: "SAFETY",
    safe1: "This service does not replace medical care, diagnosis, or therapy.",
    safe2: "If you feel in immediate danger, contact your local emergency number and crisis service right now.",
    resourceTitle: "Support Resources",
    resources: [
      {
        text: "Global crisis line directory",
        label: "Findahelpline",
        url: "https://findahelpline.com"
      },
      {
        text: "Worldwide emotional support network",
        label: "Befrienders Worldwide",
        url: "https://www.befrienders.org"
      },
      {
        text: "If you are in the U.S., call or text",
        label: "988 Lifeline",
        url: "https://988lifeline.org"
      }
    ],
    footer: "© SALJA. Keep going, one day at a time.",
    copyOk: "Copied.",
    copyFail: "Copy failed.",
    meme: [
      "Life set to hard mode. No tutorial. Still here.",
      "My mental battery says 2%, but I made it this far.",
      "Everyone looks fine online. Most people are just surviving.",
      "Today's quest: stay standing and keep breathing."
    ],
    comfort: [
      "You are doing enough today, even if it feels messy.",
      "You do not need to run at someone else's speed.",
      "A day you survived is not a small day.",
      "Even partial progress counts when your mind is tired."
    ],
    poem: [
      "In a noisy feed\nyour quiet breath\nstill counts",
      "Not perfect,\nnot finished,\nbut still moving",
      "Tonight is heavy\nbut morning\nkeeps its promise",
      "One soft inhale,\none honest step,\nthat is enough"
    ],
    quote: [
      "Storms pass. This night is not forever.",
      "Big change often begins with tiny repeats.",
      "Slow progress is still progress.",
      "You do not need perfect days to build a better life."
    ],
    action: [
      "Drink one glass of water and relax your shoulders for 10 seconds.",
      "Put your phone down and look outside for 30 seconds.",
      "Write one honest sentence about how you feel.",
      "Take five slow breaths with both feet on the ground."
    ]
  },
  ja: {
    hero: "死なないで、生きよう。今日は今日だけでいい。",
    generate: "今日のSALJAを受け取る",
    reroll: "もう一度",
    save: "文章を保存",
    share: "共有文をコピー",
    quick: "Get SALJA",
    lang: "Language",
    ticker: "Ticker: SALJA",
    keys: [
      "ミーム風キャプション",
      "慰めの一文",
      "短い詩",
      "名言の言い換え",
      "今日の小さな行動"
    ],
    whyTitle: "WHY SALJA",
    why1: "比較疲れや無気力のとき、30秒で読める心の休憩を届けます。",
    why2: "ユーモアで入りやすくし、小さな行動で今日をつなぎます。",
    safeTitle: "SAFETY",
    safe1: "本サービスは医療・診断・治療の代替ではありません。",
    safe2: "今すぐ危険を感じる場合は、地域の緊急連絡先と信頼できる支援窓口へ連絡してください。",
    resourceTitle: "サポート情報",
    resources: [
      {
        text: "各国の危機支援先を探す",
        label: "Findahelpline",
        url: "https://findahelpline.com"
      },
      {
        text: "世界の相談ネットワーク",
        label: "Befrienders Worldwide",
        url: "https://www.befrienders.org"
      },
      {
        text: "米国内にいる場合",
        label: "988 Lifeline",
        url: "https://988lifeline.org"
      }
    ],
    footer: "© SALJA. Keep going, one day at a time.",
    copyOk: "コピーしました。",
    copyFail: "コピーに失敗しました。",
    meme: [
      "人生ハードモード。説明書なし。それでも進行中。",
      "メンタル2%表示でも、ここまで来た。",
      "みんな平気そうに見えて、実はみんな必死。",
      "今日のミッション: 倒れずに一日を終える。"
    ],
    comfort: [
      "完璧じゃなくていい。今日を越えたあなたは十分えらい。",
      "他人のペースではなく、あなたの呼吸で進めばいい。",
      "折れそうでも耐えた一日は、ちゃんと価値がある。",
      "全部できなくても、前に進もうとした事実が大事。"
    ],
    poem: [
      "静かな夜\n小さな呼吸が\n明日をつなぐ",
      "転んでも\n終わりじゃない\nまだ歩ける",
      "比べる手を止め\nいまの自分に\n居場所をつくる",
      "重い気分でも\nひと息ずつで\n道は続く"
    ],
    quote: [
      "嵐は続かない。夜は必ず明ける。",
      "大きな変化は、小さな繰り返しから始まる。",
      "遅くても、止まらなければ前進している。",
      "完璧より大切なのは、あきらめない方向。"
    ],
    action: [
      "水を一杯飲んで、肩を10秒ゆるめる。",
      "スマホを置いて、30秒だけ外を見る。",
      "今の気持ちを一文だけメモする。",
      "足の裏を感じながら、ゆっくり5回呼吸する。"
    ]
  },
  es: {
    hero: "No te rindas. Vivamos hoy, solo hoy.",
    generate: "Recibir SALJA de hoy",
    reroll: "Actualizar",
    save: "Guardar texto",
    share: "Copiar texto para compartir",
    quick: "Get SALJA",
    lang: "Language",
    ticker: "Ticker: SALJA",
    keys: [
      "Caption meme",
      "Frase de consuelo",
      "Poema corto",
      "Cita reinterpretada",
      "Una acción pequeña"
    ],
    whyTitle: "WHY SALJA",
    why1: "SALJA entrega apoyo emocional en 30 segundos cuando pesa la comparación y el cansancio.",
    why2: "El humor abre la puerta y una acción mínima te ayuda a sostener el día.",
    safeTitle: "SAFETY",
    safe1: "Este servicio no reemplaza atención médica, diagnóstico ni terapia.",
    safe2: "Si sientes peligro inmediato, contacta ahora al número de emergencia local y a un servicio de crisis confiable.",
    resourceTitle: "Recursos de apoyo",
    resources: [
      {
        text: "Directorio global de ayuda en crisis",
        label: "Findahelpline",
        url: "https://findahelpline.com"
      },
      {
        text: "Red mundial de apoyo emocional",
        label: "Befrienders Worldwide",
        url: "https://www.befrienders.org"
      },
      {
        text: "Si estás en EE. UU.",
        label: "988 Lifeline",
        url: "https://988lifeline.org"
      }
    ],
    footer: "© SALJA. Keep going, one day at a time.",
    copyOk: "Copiado.",
    copyFail: "Error al copiar.",
    meme: [
      "Modo difícil activado. Sin tutorial. Seguimos aquí.",
      "Batería mental al 2%, pero llegué hasta acá.",
      "En redes todo parece perfecto. En realidad, todos están aguantando.",
      "Misión de hoy: respirar y terminar el día en pie."
    ],
    comfort: [
      "Hoy ya estás haciendo suficiente, aunque no se vea perfecto.",
      "No tienes que vivir al ritmo de otra persona.",
      "Sobrevivir este día también cuenta como logro.",
      "Aunque avances poco, sigue siendo avance."
    ],
    poem: [
      "Noche pesada,\nrespira lento,\naún hay mañana",
      "No perfecto,\nno terminado,\npero en camino",
      "Cuando dejas de compararte,\nvuelve a aparecer\nun poco de luz",
      "Un paso suave,\nun respiro honesto,\ny sigues aquí"
    ],
    quote: [
      "Las tormentas pasan; esta noche también pasará.",
      "Los cambios grandes nacen de repeticiones pequeñas.",
      "Ir lento también es avanzar.",
      "No necesitas días perfectos para construir una vida mejor."
    ],
    action: [
      "Bebe un vaso de agua y suelta los hombros por 10 segundos.",
      "Deja el teléfono y mira por la ventana 30 segundos.",
      "Escribe una sola frase honesta sobre cómo te sientes.",
      "Haz cinco respiraciones lentas con ambos pies en el suelo."
    ]
  }
};

const els = {
  langToggle: document.getElementById("langToggle"),
  langMenu: document.getElementById("langMenu"),
  langItems: document.querySelectorAll(".lang-item"),
  quickGenerate: document.getElementById("quickGenerate"),
  heroCopy: document.getElementById("heroCopy"),
  generateBtn: document.getElementById("generateBtn"),
  rerollBtn: document.getElementById("rerollBtn"),
  saveBtn: document.getElementById("saveBtn"),
  shareBtn: document.getElementById("shareBtn"),
  tickerBadge: document.getElementById("tickerBadge"),
  keys: [
    document.getElementById("k1"),
    document.getElementById("k2"),
    document.getElementById("k3"),
    document.getElementById("k4"),
    document.getElementById("k5")
  ],
  vals: [
    document.getElementById("v1"),
    document.getElementById("v2"),
    document.getElementById("v3"),
    document.getElementById("v4"),
    document.getElementById("v5")
  ],
  status: document.getElementById("status"),
  whyTitle: document.getElementById("whyTitle"),
  why1: document.getElementById("why1"),
  why2: document.getElementById("why2"),
  safeTitle: document.getElementById("safeTitle"),
  safe1: document.getElementById("safe1"),
  safe2: document.getElementById("safe2"),
  resourceTitle: document.getElementById("resourceTitle"),
  resourceList: document.getElementById("resourceList"),
  footerText: document.getElementById("footerText")
};

const supported = ["ko", "en", "ja", "es"];
const randomPick = (arr) => arr[Math.floor(Math.random() * arr.length)];

const state = {
  lang: "ko",
  bundle: ["", "", "", "", ""]
};

const detectLang = () => {
  const code = (navigator.language || "ko").toLowerCase().slice(0, 2);
  return supported.includes(code) ? code : "ko";
};

const setMenuOpen = (open) => {
  els.langMenu.classList.toggle("open", open);
  els.langToggle.setAttribute("aria-expanded", String(open));
};

const flashStatus = (message, isError = false) => {
  els.status.textContent = message;
  els.status.style.color = isError ? "#ffd4d4" : "#b7f8e4";
  window.clearTimeout(flashStatus.timer);
  flashStatus.timer = window.setTimeout(() => {
    els.status.textContent = "";
  }, 1800);
};

const createBundle = () => {
  const t = textByLang[state.lang];
  state.bundle = [
    randomPick(t.meme),
    randomPick(t.comfort),
    randomPick(t.poem),
    randomPick(t.quote),
    randomPick(t.action)
  ];
};

const renderResources = () => {
  const t = textByLang[state.lang];
  els.resourceList.innerHTML = "";
  t.resources.forEach((item) => {
    const li = document.createElement("li");
    const prefix = document.createElement("span");
    prefix.textContent = `${item.text}: `;
    li.appendChild(prefix);

    const link = document.createElement("a");
    link.href = item.url;
    link.target = "_blank";
    link.rel = "noopener noreferrer";
    link.textContent = item.label;
    li.appendChild(link);

    els.resourceList.appendChild(li);
  });
};

const renderText = () => {
  const t = textByLang[state.lang];
  document.documentElement.lang = state.lang;
  document.title = `SALJA | ${t.hero}`;
  els.heroCopy.textContent = t.hero;
  els.generateBtn.textContent = t.generate;
  els.rerollBtn.textContent = t.reroll;
  els.saveBtn.textContent = t.save;
  els.shareBtn.textContent = t.share;
  els.quickGenerate.textContent = t.quick;
  els.langToggle.textContent = t.lang;
  els.tickerBadge.textContent = t.ticker;
  els.whyTitle.textContent = t.whyTitle;
  els.why1.textContent = t.why1;
  els.why2.textContent = t.why2;
  els.safeTitle.textContent = t.safeTitle;
  els.safe1.textContent = t.safe1;
  els.safe2.textContent = t.safe2;
  els.resourceTitle.textContent = t.resourceTitle;
  els.footerText.textContent = t.footer;

  els.keys.forEach((node, i) => {
    node.textContent = t.keys[i];
  });

  els.langItems.forEach((btn) => {
    const checked = btn.dataset.lang === state.lang;
    btn.setAttribute("aria-checked", String(checked));
  });

  renderResources();
};

const renderBundle = () => {
  els.vals.forEach((node, i) => {
    node.textContent = state.bundle[i];
  });
};

const generate = () => {
  createBundle();
  renderBundle();
};

const bundleAsText = () => {
  const t = textByLang[state.lang];
  return [
    "SALJA",
    t.ticker,
    "",
    `${t.keys[0]}: ${state.bundle[0]}`,
    `${t.keys[1]}: ${state.bundle[1]}`,
    `${t.keys[2]}: ${state.bundle[2]}`,
    `${t.keys[3]}: ${state.bundle[3]}`,
    `${t.keys[4]}: ${state.bundle[4]}`
  ].join("\n");
};

const shareAsText = () => {
  const t = textByLang[state.lang];
  return [
    "SALJA",
    t.hero,
    "",
    `${t.keys[1]}: ${state.bundle[1]}`,
    `${t.keys[4]}: ${state.bundle[4]}`,
    "#SALJA"
  ].join("\n");
};

const copyText = async (text) => {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    await navigator.clipboard.writeText(text);
    return;
  }

  const ta = document.createElement("textarea");
  ta.value = text;
  ta.setAttribute("readonly", "");
  ta.style.position = "absolute";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.select();
  const ok = document.execCommand("copy");
  document.body.removeChild(ta);
  if (!ok) {
    throw new Error("copy failed");
  }
};

els.langToggle.addEventListener("click", () => {
  setMenuOpen(!els.langMenu.classList.contains("open"));
});

document.addEventListener("click", (event) => {
  if (!event.target.closest(".lang")) {
    setMenuOpen(false);
  }
});

els.langItems.forEach((btn) => {
  btn.addEventListener("click", () => {
    state.lang = btn.dataset.lang;
    renderText();
    generate();
    setMenuOpen(false);
  });
});

els.generateBtn.addEventListener("click", generate);
els.rerollBtn.addEventListener("click", generate);
els.quickGenerate.addEventListener("click", generate);

els.saveBtn.addEventListener("click", async () => {
  const t = textByLang[state.lang];
  try {
    await copyText(bundleAsText());
    flashStatus(t.copyOk);
  } catch (_) {
    flashStatus(t.copyFail, true);
  }
});

els.shareBtn.addEventListener("click", async () => {
  const t = textByLang[state.lang];
  try {
    await copyText(shareAsText());
    flashStatus(t.copyOk);
  } catch (_) {
    flashStatus(t.copyFail, true);
  }
});

state.lang = detectLang();
renderText();
generate();
